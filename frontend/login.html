<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClientFlow - Login</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="login-container">
        <div class="login-box">
            <div class="logo">
                <h1>ClientFlow</h1>
                <p>Sistema de Gestão Multi-Empresas</p>
            </div>
            <!-- Bloco de Status do Sistema -->
            <div id="status-sistema" class="status-sistema" style="margin-bottom:18px; border:1px solid #ccc; border-radius:8px; padding:12px; background:#f9f9f9;">
                <h3 style="margin-top:0;">Status do Sistema</h3>
                <div id="status-sistema-msg">
                    <span>Verificando conexão...</span>
                </div>
            </div>
            
            <div class="tabs">
                <button class="tab-button active" onclick="showTab('login')">Login</button>
                <button class="tab-button" onclick="showTab('cadastro')">Cadastrar Empresa</button>
            </div>
            
            <!-- TAB DE LOGIN -->
            <div id="login-tab" class="tab-content active">
                <form id="login-form" onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label for="login-email">Email</label>
                        <input type="email" id="login-email" required placeholder="seu@email.com">
                    </div>
                    
                    <div class="form-group">
                        <label for="login-senha">Senha</label>
                        <input type="password" id="login-senha" required placeholder="••••••••">
                    </div>
                    
                    <button type="submit" class="btn-primary">Entrar</button>
                </form>
            </div>
            
            <!-- TAB DE CADASTRO -->
            <div id="cadastro-tab" class="tab-content">
                <form id="cadastro-form" onsubmit="handleCadastro(event)">
                    <div class="form-group">
                        <label for="nome-empresa">Nome da Empresa</label>
                        <input type="text" id="nome-empresa" required placeholder="Oficina Silva">
                    </div>
                    
                    <div class="form-group">
                        <label for="nicho">Nicho/Segmento</label>
                        <select id="nicho" required>
                            <option value="">Selecione...</option>
                            <option value="Mecânica">Mecânica</option>
                            <option value="Elétrica">Elétrica Automotiva</option>
                            <option value="Funilaria">Funilaria e Pintura</option>
                            <option value="Pneus">Pneus e Alinhamento</option>
                            <option value="Outro">Outro</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="telefone">Telefone</label>
                        <input type="tel" id="telefone" required placeholder="(11) 99999-9999">
                    </div>
                    
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" required placeholder="contato@empresa.com">
                    </div>
                    
                    <div class="form-group">
                        <label for="senha">Senha</label>
                        <input type="password" id="senha" required placeholder="Mínimo 6 caracteres" minlength="6">
                    </div>
                    
                    <button type="submit" class="btn-primary">Criar Conta</button>
                </form>
            </div>
            
            <div id="message" class="message"></div>
        </div>
    </div>
    
    <script src="/static/script.js"></script>
    <script>
        // Funções específicas da página de login

        // Diagnóstico visual de conexão com backend
        const STATUS_API_URL = API_URL;
        async function checarStatusSistema() {
            const statusDiv = document.getElementById('status-sistema-msg');
            try {
                const resp = await fetch(STATUS_API_URL);
                if (!resp.ok) throw new Error('Status HTTP: ' + resp.status);
                statusDiv.innerHTML = `<span style='color:green;font-weight:bold;'>Servidor conectado</span><br>API online`;
            } catch (e) {
                statusDiv.innerHTML = `<span style='color:red;font-weight:bold;'>Erro ao conectar com o servidor</span><br><span style='font-size:13px;color:#a00;'>${e.message || e}</span>`;
            }
        }
        window.addEventListener('DOMContentLoaded', checarStatusSistema);
        
        function showTab(tabName) {
            // Esconder todas as tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Mostrar tab selecionada
            if (tabName === 'login') {
                document.getElementById('login-tab').classList.add('active');
                document.querySelectorAll('.tab-button')[0].classList.add('active');
            } else {
                document.getElementById('cadastro-tab').classList.add('active');
                document.querySelectorAll('.tab-button')[1].classList.add('active');
            }
            
            // Limpar mensagens
            document.getElementById('message').textContent = '';
        }

        function unwrapApiPayload(payload) {
            if (payload && typeof payload === 'object' && payload.status && Object.prototype.hasOwnProperty.call(payload, 'data')) {
                return payload.data;
            }
            return payload;
        }

        function getApiErrorMessage(payload) {
            if (payload && payload.error && payload.error.message) {
                return payload.error.message;
            }
            if (payload && payload.detail) {
                return payload.detail;
            }
            return 'Erro ao processar requisicao';
        }
        
        async function handleLogin(event) {
            event.preventDefault();
            console.log('[LOGIN] Iniciando...');
            
            const email = document.getElementById('login-email').value.trim();
            const senha = document.getElementById('login-senha').value;
            
            if (!email || !senha) {
                showMessage('✗ Preencha email e senha!', 'error');
                return;
            }
            
            showMessage('Autenticando...', 'info');
            
            try {
                console.log('[LOGIN] Enviando para:', `${API_URL}/api/empresas/login`);
                const response = await fetch(`${API_URL}/api/empresas/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email_login: email, senha: senha })
                });
                console.log('[LOGIN] Status:', response.status);
                
                const raw = await response.json();
                console.log('[LOGIN] Resposta:', raw);
                
                if (response.ok) {
                    console.log('[LOGIN] Sucesso!');
                    const data = raw.data || raw;
                    localStorage.setItem('token', data.token || data.access_token);
                    localStorage.setItem('access_token', data.access_token);
                    localStorage.setItem('empresa', JSON.stringify(data.empresa || data));
                    showMessage('✓ Login realizado! Redirecionando...', 'success');
                    setTimeout(() => {
                        window.location.href = '/dashboard.html';
                    }, 1000);
                } else {
                    const errorMsg = raw?.error?.message || raw?.detail || 'Credenciais inválidas';
                    console.log('[LOGIN] Erro:', errorMsg);
                    showMessage('✗ ' + errorMsg, 'error');
                }
            } catch (error) {
                console.error('[LOGIN] Exceção:', error);
                showMessage('✗ Erro de conexão: ' + error.message, 'error');
            }
        }
        
        async function handleCadastro(event) {
            event.preventDefault();
            console.log('[CADASTRO] Iniciando...');
            
            const nome_empresa = document.getElementById('nome-empresa').value.trim();
            const nicho = document.getElementById('nicho').value.trim();
            const telefone = document.getElementById('telefone').value.trim();
            const email_login = document.getElementById('email').value.trim();
            const senha = document.getElementById('senha').value;
            
            // Validação básica
            if (!nome_empresa || !nicho || !email_login || !senha) {
                showMessage('Preencha todos os campos obrigatórios!', 'error');
                console.log('[CADASTRO] Campos vazios');
                return;
            }
            
            const empresa = { nome_empresa, nicho, telefone, email_login, senha };
            console.log('[CADASTRO] Dados:', { nome_empresa, nicho, email_login });
            
            showMessage('Processando cadastro...', 'info');
            
            try {
                console.log('[CADASTRO] Enviando para:', `${API_URL}/api/empresas/cadastrar`);
                const response = await fetch(`${API_URL}/api/empresas/cadastrar`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(empresa)
                });
                
                console.log('[CADASTRO] Status:', response.status);
                const raw = await response.json();
                console.log('[CADASTRO] Resposta:', raw);
                
                if (response.ok) {
                    console.log('[CADASTRO] Sucesso!');
                    showMessage('✓ Empresa cadastrada com sucesso! Faça login agora.', 'success');
                    document.getElementById('cadastro-form').reset();
                    setTimeout(() => { showTab('login'); }, 2000);
                } else {
                    const errorMsg = raw?.error?.message || raw?.detail || 'Erro no cadastro';
                    console.log('[CADASTRO] Erro:', errorMsg);
                    showMessage('✗ ' + errorMsg, 'error');
                }
            } catch (error) {
                console.error('[CADASTRO] Exceção:', error);
                showMessage('✗ Erro ao conectar: ' + error.message, 'error');
            }
        }
        
        function showMessage(msg, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = msg;
            messageDiv.className = `message ${type}`;
            messageDiv.style.display = 'block';
            messageDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            console.log('[MESSAGE]', type.toUpperCase(), msg);
            
            // Auto-hide após 8 segundos para mensagens de sucesso
            if (type === 'success') {
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 8000);
            }
        }
        
        // Verificar se já está logado
        if (localStorage.getItem('token')) {
            window.location.href = 'dashboard.html';
        }
    </script>
</body>
</html>
