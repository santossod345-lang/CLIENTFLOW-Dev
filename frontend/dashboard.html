<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClientFlow - Dashboard</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body class="cf-body">
    <div class="cf-shell">
        <aside class="cf-sidebar">
            <div class="cf-brand">
                <div class="cf-logo">
                    <span class="cf-logo-dot"></span>
                </div>
                <div>
                    <h1 class="cf-brand-title">ClientFlow</h1>
                    <p class="cf-brand-sub">SaaS Intelligence Platform</p>
                </div>
            </div>

            <nav class="cf-nav">
                <button class="cf-nav-item active" data-section="dashboard" onclick="showSection('dashboard')">
                    <span class="cf-nav-icon">üè†</span>
                    Dashboard
                </button>
                <button class="cf-nav-item" data-section="clientes" onclick="showSection('clientes')">
                    <span class="cf-nav-icon">üë•</span>
                    CRM
                </button>
                <button class="cf-nav-item" data-section="atendimentos" onclick="showSection('atendimentos')">
                    <span class="cf-nav-icon">üõ†Ô∏è</span>
                    Atendimentos
                </button>
                <button class="cf-nav-item" data-section="novo-cliente" onclick="showSection('novo-cliente')">
                    <span class="cf-nav-icon">‚ûï</span>
                    Novo Cliente
                </button>
                <button class="cf-nav-item" data-section="novo-atendimento" onclick="showSection('novo-atendimento')">
                    <span class="cf-nav-icon">üßæ</span>
                    Novo Atendimento
                </button>
                <div class="cf-nav-divider"></div>
                <button class="cf-nav-item" data-section="financeiro">
                    <span class="cf-nav-icon">üìà</span>
                    Financeiro
                </button>
                <button class="cf-nav-item" data-section="relatorios">
                    <span class="cf-nav-icon">üìä</span>
                    Relatorios
                </button>
                <button class="cf-nav-item" data-section="whatsapp">
                    <span class="cf-nav-icon">üí¨</span>
                    WhatsApp
                </button>
                <button class="cf-nav-item" data-section="configuracoes">
                    <span class="cf-nav-icon">‚öôÔ∏è</span>
                    Configuracoes
                </button>
            </nav>

            <div class="cf-support">
                <div class="cf-support-card">
                    <p>Suporte premium</p>
                    <small>Resposta em ate 1 hora</small>
                    <button class="cf-support-btn">Falar com time</button>
                </div>
            </div>

            <div class="cf-user">
                <div>
                    <strong id="empresa-nome">Carregando...</strong>
                    <small id="empresa-nicho"></small>
                </div>
                <button class="cf-logout" onclick="handleLogout()">Sair</button>
            </div>
        </aside>

        <main class="cf-main">
            <header class="cf-topbar">
                <div class="cf-search">
                    <span class="cf-search-icon">üîé</span>
                    <input id="busca-global" type="text" placeholder="Buscar clientes, atendimentos..." oninput="handleBuscaGlobal()">
                </div>
                <div class="cf-top-actions">
                    <span class="cf-pill" id="plan-name">Plano Free</span>
                    <span class="cf-status" id="system-status">Status: verificando</span>
                    <button class="cf-icon-btn" title="Notificacoes">üîî</button>
                    <button class="cf-icon-btn" title="Mensagens">üí¨</button>
                    <div class="cf-avatar">AF</div>
                </div>
            </header>

            <div id="resultados-busca" class="cf-search-results"></div>

            <section id="dashboard-section" class="cf-section active">
                <div class="cf-kpi-grid">
                    <div class="cf-card cf-kpi">
                        <div>
                            <p>Clientes Ativos</p>
                            <h2 id="total-clientes">0</h2>
                            <span class="cf-kpi-tag">+12% este mes</span>
                        </div>
                        <div class="cf-kpi-icon">üë•</div>
                    </div>
                    <div class="cf-card cf-kpi">
                        <div>
                            <p>Atendimentos Hoje</p>
                            <h2 id="total-atendimentos">0</h2>
                            <span class="cf-kpi-tag">+8% vs ontem</span>
                        </div>
                        <div class="cf-kpi-icon">‚ö°</div>
                    </div>
                    <div class="cf-card cf-kpi">
                        <div>
                            <p>Clientes Novos</p>
                            <h2 id="clientes-novos">0</h2>
                            <span class="cf-kpi-tag">periodo atual</span>
                        </div>
                        <div class="cf-kpi-icon">‚ú®</div>
                    </div>
                    <div class="cf-card cf-kpi">
                        <div>
                            <p>Taxa de Atividade</p>
                            <h2 id="taxa-atividade">0%</h2>
                            <span class="cf-kpi-tag">media diaria</span>
                        </div>
                        <div class="cf-kpi-icon">üíö</div>
                    </div>
                </div>

                <div class="cf-grid">
                    <div class="cf-card cf-chart">
                        <div class="cf-card-header">
                            <h3>Evolucao de Atendimentos</h3>
                            <div class="cf-chip-group">
                                <span class="cf-chip active">Mes</span>
                                <span class="cf-chip">Semana</span>
                                <span class="cf-chip">Hoje</span>
                            </div>
                        </div>
                        <canvas id="grafico-atendimentos" height="120"></canvas>
                    </div>

                    <div class="cf-card cf-agenda">
                        <div class="cf-card-header">
                            <h3>Agenda de Hoje</h3>
                            <button class="cf-btn-primary">+ Novo Agendamento</button>
                        </div>
                        <div id="atendimentos-recentes" class="cf-list">
                            <p>Carregando...</p>
                        </div>
                    </div>
                </div>

                <div class="cf-grid">
                    <div class="cf-card cf-mini">
                        <h4>Atendimentos por Status</h4>
                        <div class="cf-ring">
                            <div class="cf-ring-center">
                                <span id="total-atendimentos-ring">0</span>
                                <small>Total</small>
                            </div>
                        </div>
                        <div class="cf-legend">
                            <span><i class="dot dot-green"></i>Concluido</span>
                            <span><i class="dot dot-yellow"></i>Em andamento</span>
                            <span><i class="dot dot-red"></i>Pendente</span>
                        </div>
                    </div>

                    <div class="cf-card cf-mini">
                        <h4>Clientes Recentes</h4>
                        <div id="clientes-recentes" class="cf-list">
                            <p>Carregando...</p>
                        </div>
                    </div>

                    <div class="cf-card cf-mini">
                        <h4>Ranking de Clientes</h4>
                        <div id="ranking-clientes" class="cf-list">
                            <p>Carregando...</p>
                        </div>
                    </div>
                </div>

                <div class="cf-grid">
                    <div class="cf-card cf-chart">
                        <div class="cf-card-header">
                            <h3>Novos Clientes</h3>
                            <span class="cf-chip">Mensal</span>
                        </div>
                        <canvas id="grafico-clientes" height="120"></canvas>
                    </div>
                    <div class="cf-card cf-side">
                        <h4>Clientes para Retorno</h4>
                        <div id="clientes-retorno" class="cf-list">
                            <p>Carregando...</p>
                        </div>
                        <div class="cf-divider"></div>
                        <h4>Servicos mais comuns</h4>
                        <div id="servicos-comuns" class="cf-list">
                            <p>Carregando...</p>
                        </div>
                    </div>
                </div>

                <div class="cf-card" style="display:none;">
                    <input type="text" id="pergunta-ia" placeholder="Perguntar a IA">
                    <div id="ia-resposta" class="message"></div>
                </div>

                <div id="estatisticas-dashboard" style="display:none;"></div>
                <div id="clientes-para-retorno" style="display:none;"></div>
                <div id="clientes-inativos" style="display:none;"></div>
            </section>

            <section id="clientes-section" class="cf-section">
                <div class="cf-card">
                    <div class="cf-card-header">
                        <h3>Lista de Clientes</h3>
                        <div class="cf-actions">
                            <input type="text" id="filtro-clientes" placeholder="Filtrar clientes..." oninput="filtrarClientesTabela()">
                            <button class="cf-btn" onclick="loadClientes()">Atualizar</button>
                            <button class="cf-btn" onclick="exportarCSV('clientes')">Exportar CSV</button>
                        </div>
                    </div>
                    <div id="clientes-list" class="cf-table">
                        <table class="tabela-clientes">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Telefone</th>
                                    <th>Data Cadastro</th>
                                    <th></th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="clientes-tbody">
                                <tr><td colspan="5">Carregando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="cf-card" id="historico-cliente-card" style="display:none;">
                    <h3>Historico do Cliente</h3>
                    <div id="cliente-total-gasto" class="cf-highlight"></div>
                    <div id="historico-cliente" class="cf-list"></div>
                    <button class="cf-btn" onclick="fecharHistoricoCliente()">Fechar</button>
                </div>
            </section>

            <section id="atendimentos-section" class="cf-section">
                <div class="cf-card">
                    <div class="cf-card-header">
                        <h3>Lista de Atendimentos</h3>
                        <div class="cf-actions">
                            <select id="filtro-periodo" onchange="loadAtendimentos()">
                                <option value="">Todos</option>
                                <option value="hoje">Hoje</option>
                                <option value="semana">Essa semana</option>
                                <option value="mes">Esse mes</option>
                            </select>
                            <button class="cf-btn" onclick="loadAtendimentos()">Atualizar</button>
                            <button class="cf-btn" onclick="exportarCSV('atendimentos')">Exportar CSV</button>
                        </div>
                    </div>
                    <div id="atendimentos-list" class="cf-table">
                        <table class="tabela-atendimentos">
                            <thead>
                                <tr>
                                    <th>Cliente</th>
                                    <th>Tipo Servico</th>
                                    <th>Descricao</th>
                                    <th>Status</th>
                                    <th>Data</th>
                                    <th></th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="atendimentos-tbody">
                                <tr><td colspan="7">Carregando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="novo-cliente-section" class="cf-section">
                <div class="cf-card">
                    <h3>Cadastrar Novo Cliente</h3>
                    <form id="form-novo-cliente" onsubmit="handleNovoCliente(event)">
                        <div class="cf-form-grid">
                            <div class="form-group">
                                <label for="cliente-nome">Nome Completo</label>
                                <input type="text" id="cliente-nome" required placeholder="Joao Silva">
                            </div>
                            <div class="form-group">
                                <label for="cliente-telefone">Telefone</label>
                                <input type="tel" id="cliente-telefone" required placeholder="(11) 99999-9999">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="cliente-anotacoes">Anotacoes rapidas</label>
                            <textarea id="cliente-anotacoes" placeholder="Observacoes, lembretes, etc..." rows="2"></textarea>
                        </div>
                        <button type="submit" class="cf-btn-primary">Cadastrar Cliente</button>
                    </form>
                    <div id="message-cliente" class="message"></div>
                </div>
            </section>

            <section id="novo-atendimento-section" class="cf-section">
                <div class="cf-card">
                    <h3>Registrar Novo Atendimento</h3>
                    <form id="form-novo-atendimento" onsubmit="handleNovoAtendimento(event)">
                        <div class="cf-form-grid">
                            <div class="form-group">
                                <label for="atendimento-cliente">Cliente</label>
                                <select id="atendimento-cliente" required>
                                    <option value="">Carregando clientes...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="atendimento-tipo">Tipo de Atendimento</label>
                                <select id="atendimento-tipo" required>
                                    <option value="">Selecione...</option>
                                    <option value="Orcamento">Orcamento</option>
                                    <option value="Revisao">Revisao</option>
                                    <option value="Reparo">Reparo</option>
                                    <option value="Manutencao">Manutencao</option>
                                    <option value="Troca de Pecas">Troca de Pecas</option>
                                    <option value="Diagnostico">Diagnostico</option>
                                    <option value="Outros">Outros</option>
                                </select>
                            </div>
                        </div>
                        <div class="cf-form-grid">
                            <div class="form-group">
                                <label for="atendimento-veiculo">Veiculo</label>
                                <input type="text" id="atendimento-veiculo" placeholder="Ex: Honda Civic 2020">
                            </div>
                            <div class="form-group">
                                <label for="atendimento-descricao">Descricao</label>
                                <textarea id="atendimento-descricao" rows="4" required placeholder="Descreva o atendimento..."></textarea>
                            </div>
                        </div>
                        <button type="submit" class="cf-btn-primary">Registrar Atendimento</button>
                    </form>
                    <div id="message-atendimento" class="message"></div>
                </div>
            </section>
        </main>
    </div>

    <div id="onboarding-modal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close" onclick="fecharOnboarding()">&times;</span>
            <h3>Bem-vindo ao ClientFlow!</h3>
            <ul>
                <li>Cadastre clientes e atendimentos facilmente.</li>
                <li>Use a busca global para encontrar qualquer cliente.</li>
                <li>Edite ou exclua registros clicando nos botoes.</li>
                <li>Veja estatisticas, rankings e retornos previstos no dashboard.</li>
            </ul>
            <button class="cf-btn" onclick="fecharOnboarding()">Comecar</button>
        </div>
    </div>

    <div id="notificacao-retorno" class="toast" style="display:none;"></div>

    <section id="logs-section" class="cf-section" style="display:none;">
        <div class="cf-card">
            <div class="cf-card-header">
                <h3>Logs de Acoes</h3>
                <button class="cf-btn" onclick="carregarLogsAcoes()">Atualizar</button>
            </div>
            <div id="logs-acoes-list" class="cf-list"></div>
        </div>
    </section>

    <div id="global-loading" class="spinner-overlay" style="display:none;">
        <div class="spinner"></div>
    </div>

    <div id="toast-feedback" class="toast" style="display:none;"></div>

    <div id="modal-edicao" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close" onclick="fecharModalEdicao()">&times;</span>
            <h3 id="modal-edicao-titulo">Editar</h3>
            <form id="form-edicao" onsubmit="salvarEdicao(event)"></form>
        </div>
    </div>

    <script src="/static/chart.min.js"></script>
    <script src="/static/script.js"></script>
    <script>
        let empresaAtual = null;

        function showSection(section) {
            document.querySelectorAll('.cf-section').forEach(sec => sec.classList.remove('active'));
            const target = document.getElementById(`${section}-section`);
            if (target) target.classList.add('active');

            document.querySelectorAll('.cf-nav-item').forEach(btn => btn.classList.remove('active'));
            const activeBtn = Array.from(document.querySelectorAll('.cf-nav-item'))
                .find(btn => btn.dataset.section === section);
            if (activeBtn) activeBtn.classList.add('active');
        }

        async function initDashboard() {
            const token = localStorage.getItem('token');
            const empresaData = localStorage.getItem('empresa');
            if (!token || !empresaData) {
                window.location.href = 'login.html';
                return;
            }
            empresaAtual = JSON.parse(empresaData);
            document.getElementById('empresa-nome').textContent = empresaAtual.nome_empresa || 'Empresa';
            document.getElementById('empresa-nicho').textContent = empresaAtual.nicho || '';
            document.getElementById('plan-name').textContent = `Plano ${empresaAtual.plano_empresa || 'Free'}`;

            await Promise.all([
                (typeof window.loadDashboard === 'function' ? window.loadDashboard() : Promise.resolve()),
                loadClientesForSelect(),
                loadClientesRetorno(),
                loadEstatisticasDashboard(),
                loadAtendimentosRecentes(),
                loadClientesRecentes(),
            ]);

            try {
                const health = await fetch(`${API_URL}/health`);
                document.getElementById('system-status').textContent = health.ok ? '100% operacional' : 'Atencao no sistema';
            } catch {
                document.getElementById('system-status').textContent = 'Sistema instavel';
            }
        }

        window.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>
