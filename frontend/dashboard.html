<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClientFlow - Dashboard</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="dashboard-container">
        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="logo-sidebar">
                <h2>ClientFlow</h2>
            </div>
            
            <nav class="menu">
                <button class="menu-item active" onclick="showSection('dashboard')">
                    <span>üìä</span> Dashboard
                </button>
                <button class="menu-item" onclick="showSection('clientes')">
                    <span>üë•</span> Clientes
                </button>
                <button class="menu-item" onclick="showSection('atendimentos')">
                    <span>üìù</span> Atendimentos
                </button>
                <button class="menu-item" onclick="showSection('novo-cliente')">
                    <span>‚ûï</span> Novo Cliente
                </button>
                <button class="menu-item" onclick="showSection('novo-atendimento')">
                    <span>üìã</span> Novo Atendimento
                </button>
            </nav>
            
            <div class="user-info">
                <div id="empresa-info">
                    <strong id="empresa-nome">Carregando...</strong>
                    <small id="empresa-nicho"></small>
                </div>
                <button class="btn-logout" onclick="handleLogout()">Sair</button>
            </div>
        </aside>
        
        <!-- CONTE√öDO PRINCIPAL -->
        <main class="main-content">
            <header class="top-bar">
                <h1 id="page-title">Dashboard</h1>
            </header>
            
            <div class="content-area">
                <!-- SE√á√ÉO DASHBOARD -->
                <section id="dashboard-section" class="section active">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">üë•</div>
                            <div class="stat-info">
                                <h3>Total de Clientes</h3>
                                <p class="stat-number" id="total-clientes">0</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">üìù</div>
                            <div class="stat-info">
                                <h3>Total de Atendimentos</h3>
                                <p class="stat-number" id="total-atendimentos">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>Atendimentos Recentes</h3>
                        <div id="atendimentos-recentes" class="list-container">
                            <p>Carregando...</p>
                        </div>
                    </div>
                </section>
                
                <!-- SE√á√ÉO CLIENTES -->
                <section id="clientes-section" class="section">
                    <div class="card">
                        <div class="card-header">
                            <h3>Lista de Clientes</h3>
                            <button class="btn-secondary" onclick="loadClientes()">üîÑ Atualizar</button>
                        </div>
                        <div id="clientes-list" class="list-container">
                            <p>Carregando...</p>
                        </div>
                    </div>
                </section>
                
                <!-- SE√á√ÉO ATENDIMENTOS -->
                <section id="atendimentos-section" class="section">
                    <div class="card">
                        <div class="card-header">
                            <h3>Lista de Atendimentos</h3>
                            <button class="btn-secondary" onclick="loadAtendimentos()">üîÑ Atualizar</button>
                        </div>
                        <div id="atendimentos-list" class="list-container">
                            <p>Carregando...</p>
                        </div>
                    </div>
                </section>
                
                <!-- SE√á√ÉO NOVO CLIENTE -->
                <section id="novo-cliente-section" class="section">
                    <div class="card">
                        <h3>Cadastrar Novo Cliente</h3>
                        <form id="form-novo-cliente" onsubmit="handleNovoCliente(event)">
                            <div class="form-group">
                                <label for="cliente-nome">Nome Completo</label>
                                <input type="text" id="cliente-nome" required placeholder="Jo√£o Silva">
                            </div>
                            
                            <div class="form-group">
                                <label for="cliente-telefone">Telefone</label>
                                <input type="tel" id="cliente-telefone" required placeholder="(11) 99999-9999">
                            </div>
                            
                            <button type="submit" class="btn-primary">Cadastrar Cliente</button>
                        </form>
                        <div id="message-cliente" class="message"></div>
                    </div>
                </section>
                
                <!-- SE√á√ÉO NOVO ATENDIMENTO -->
                <section id="novo-atendimento-section" class="section">
                    <div class="card">
                        <h3>Registrar Novo Atendimento</h3>
                        <form id="form-novo-atendimento" onsubmit="handleNovoAtendimento(event)">
                            <div class="form-group">
                                <label for="atendimento-cliente">Cliente</label>
                                <select id="atendimento-cliente" required>
                                    <option value="">Carregando clientes...</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="atendimento-tipo">Tipo de Atendimento</label>
                                <select id="atendimento-tipo" required>
                                    <option value="">Selecione...</option>
                                    <option value="Or√ßamento">Or√ßamento</option>
                                    <option value="Revis√£o">Revis√£o</option>
                                    <option value="Reparo">Reparo</option>
                                    <option value="Manuten√ß√£o">Manuten√ß√£o</option>
                                    <option value="Troca de Pe√ßas">Troca de Pe√ßas</option>
                                    <option value="Diagn√≥stico">Diagn√≥stico</option>
                                    <option value="Outros">Outros</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="atendimento-veiculo">Ve√≠culo</label>
                                <input type="text" id="atendimento-veiculo" placeholder="Ex: Honda Civic 2020">
                            </div>
                            
                            <div class="form-group">
                                <label for="atendimento-descricao">Descri√ß√£o</label>
                                <textarea id="atendimento-descricao" rows="4" required placeholder="Descreva o atendimento..."></textarea>
                            </div>
                            
                            <button type="submit" class="btn-primary">Registrar Atendimento</button>
                        </form>
                        <div id="message-atendimento" class="message"></div>
                    </div>
                </section>
            </div>
        </main>
    </div>
    
    <script src="script.js"></script>
    <script>
        // Vari√°veis globais
        let empresaAtual = null;
        let clientesCache = [];
        
        // Inicializar dashboard
        function initDashboard() {
            // Verificar autentica√ß√£o
            const token = localStorage.getItem('token');
            const empresaData = localStorage.getItem('empresa');
            
            if (!token || !empresaData) {
                window.location.href = 'login.html';
                return;
            }
            
            empresaAtual = JSON.parse(empresaData);
            
            // Mostrar informa√ß√µes da empresa
            document.getElementById('empresa-nome').textContent = empresaAtual.nome_empresa;
            document.getElementById('empresa-nicho').textContent = empresaAtual.nicho;
            
            // Carregar dados do dashboard
            loadDashboard();
            loadClientesForSelect();
        }
        
        async function loadDashboard() {
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch(`${API_URL}/dashboard?token=${token}`);
                const data = await response.json();
                
                if (response.ok) {
                    // Atualizar estat√≠sticas
                    document.getElementById('total-clientes').textContent = data.estatisticas.total_clientes;
                    document.getElementById('total-atendimentos').textContent = data.estatisticas.total_atendimentos;
                    
                    // Atualizar atendimentos recentes
                    const container = document.getElementById('atendimentos-recentes');
                    if (data.atendimentos_recentes.length === 0) {
                        container.innerHTML = '<p>Nenhum atendimento registrado ainda.</p>';
                    } else {
                        container.innerHTML = data.atendimentos_recentes.map(at => `
                            <div class="list-item">
                                <div>
                                    <strong>${at.cliente_nome}</strong>
                                    <p>${at.tipo} - ${at.data}</p>
                                </div>
                            </div>
                        `).join('');
                    }
                } else {
                    if (response.status === 401) {
                        handleLogout();
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar dashboard:', error);
            }
        }
        
        async function loadClientes() {
            const token = localStorage.getItem('token');
            const container = document.getElementById('clientes-list');
            container.innerHTML = '<p>Carregando...</p>';
            
            try {
                const response = await fetch(`${API_URL}/clientes?token=${token}`);
                const clientes = await response.json();
                
                if (response.ok) {
                    clientesCache = clientes;
                    
                    if (clientes.length === 0) {
                        container.innerHTML = '<p>Nenhum cliente cadastrado ainda.</p>';
                    } else {
                        container.innerHTML = clientes.map(cliente => `
                            <div class="list-item">
                                <div>
                                    <strong>${cliente.nome}</strong>
                                    <p>üì± ${cliente.telefone}</p>
                                    <small>Primeiro contato: ${new Date(cliente.data_primeiro_contato).toLocaleDateString('pt-BR')}</small>
                                </div>
                            </div>
                        `).join('');
                    }
                } else {
                    container.innerHTML = '<p>Erro ao carregar clientes.</p>';
                }
            } catch (error) {
                console.error('Erro ao carregar clientes:', error);
                container.innerHTML = '<p>Erro ao carregar clientes.</p>';
            }
        }
        
        async function loadAtendimentos() {
            const token = localStorage.getItem('token');
            const container = document.getElementById('atendimentos-list');
            container.innerHTML = '<p>Carregando...</p>';
            
            try {
                const response = await fetch(`${API_URL}/atendimentos?token=${token}`);
                const atendimentos = await response.json();
                
                if (response.ok) {
                    if (atendimentos.length === 0) {
                        container.innerHTML = '<p>Nenhum atendimento registrado ainda.</p>';
                    } else {
                        container.innerHTML = atendimentos.map(at => `
                            <div class="list-item">
                                <div>
                                    <strong>${at.cliente_nome}</strong>
                                    <p><span class="badge">${at.tipo}</span> ${at.veiculo || 'Sem ve√≠culo'}</p>
                                    <p>${at.descricao}</p>
                                    <small>üìÖ ${new Date(at.data).toLocaleString('pt-BR')}</small>
                                </div>
                            </div>
                        `).join('');
                    }
                } else {
                    container.innerHTML = '<p>Erro ao carregar atendimentos.</p>';
                }
            } catch (error) {
                console.error('Erro ao carregar atendimentos:', error);
                container.innerHTML = '<p>Erro ao carregar atendimentos.</p>';
            }
        }
        
        async function loadClientesForSelect() {
            const token = localStorage.getItem('token');
            const select = document.getElementById('atendimento-cliente');
            
            try {
                const response = await fetch(`${API_URL}/clientes?token=${token}`);
                const clientes = await response.json();
                
                if (response.ok) {
                    if (clientes.length === 0) {
                        select.innerHTML = '<option value="">Nenhum cliente cadastrado</option>';
                    } else {
                        select.innerHTML = '<option value="">Selecione um cliente...</option>' +
                            clientes.map(c => `<option value="${c.id}">${c.nome} - ${c.telefone}</option>`).join('');
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar clientes:', error);
            }
        }
        
        async function handleNovoCliente(event) {
            event.preventDefault();
            
            const token = localStorage.getItem('token');
            const cliente = {
                nome: document.getElementById('cliente-nome').value,
                telefone: document.getElementById('cliente-telefone').value
            };
            
            try {
                const response = await fetch(`${API_URL}/clientes?token=${token}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(cliente)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showMessageInSection('message-cliente', 'Cliente cadastrado com sucesso!', 'success');
                    document.getElementById('form-novo-cliente').reset();
                    loadClientesForSelect();
                    loadDashboard();
                } else {
                    showMessageInSection('message-cliente', data.detail || 'Erro ao cadastrar cliente', 'error');
                }
            } catch (error) {
                showMessageInSection('message-cliente', 'Erro ao conectar com o servidor', 'error');
            }
        }
        
        async function handleNovoAtendimento(event) {
            event.preventDefault();
            
            const token = localStorage.getItem('token');
            const atendimento = {
                cliente_id: parseInt(document.getElementById('atendimento-cliente').value),
                tipo: document.getElementById('atendimento-tipo').value,
                veiculo: document.getElementById('atendimento-veiculo').value || null,
                descricao: document.getElementById('atendimento-descricao').value
            };
            
            try {
                const response = await fetch(`${API_URL}/atendimentos?token=${token}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(atendimento)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showMessageInSection('message-atendimento', 'Atendimento registrado com sucesso!', 'success');
                    document.getElementById('form-novo-atendimento').reset();
                    loadDashboard();
                } else {
                    showMessageInSection('message-atendimento', data.detail || 'Erro ao registrar atendimento', 'error');
                }
            } catch (error) {
                showMessageInSection('message-atendimento', 'Erro ao conectar com o servidor', 'error');
            }
        }
        
        function showSection(sectionName) {
            // Atualizar t√≠tulo
            const titles = {
                'dashboard': 'Dashboard',
                'clientes': 'Clientes',
                'atendimentos': 'Atendimentos',
                'novo-cliente': 'Novo Cliente',
                'novo-atendimento': 'Novo Atendimento'
            };
            document.getElementById('page-title').textContent = titles[sectionName];
            
            // Esconder todas as se√ß√µes
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remover active de todos os itens do menu
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Mostrar se√ß√£o selecionada
            document.getElementById(`${sectionName}-section`).classList.add('active');
            
            // Ativar item do menu
            event.target.classList.add('active');
            
            // Carregar dados espec√≠ficos da se√ß√£o
            if (sectionName === 'dashboard') {
                loadDashboard();
            } else if (sectionName === 'clientes') {
                loadClientes();
            } else if (sectionName === 'atendimentos') {
                loadAtendimentos();
            }
        }
        
        function showMessageInSection(elementId, msg, type) {
            const messageDiv = document.getElementById(elementId);
            messageDiv.textContent = msg;
            messageDiv.className = `message ${type}`;
            messageDiv.style.display = 'block';
            
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 5000);
        }
        
        function handleLogout() {
            localStorage.removeItem('token');
            localStorage.removeItem('empresa');
            window.location.href = 'login.html';
        }
        
        // Inicializar ao carregar a p√°gina
        window.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>
