---
name: Terraform Apply (Manual)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - prod
      plan_short_sha:
        description: 'Short SHA of the terraform plan to apply (7 chars)'
        required: true
        default: ''

jobs:
  terraform-apply:
    runs-on: ubuntu-latest
    # This uses GitHub Environments for manual approvals. Configure environment protection in repo settings.
    environment: ${{ github.event.inputs.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: '1.4.6'

      - name: Set ENV
        run: |
          echo "ENV=${{ github.event.inputs.environment }}" >> $GITHUB_ENV
          echo "SHORT_SHA=${GITHUB_SHA::7}" >> $GITHUB_ENV

      - name: List available tfplan artifacts and suggest one
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          ENV: ${{ env.ENV }}
        run: |
          set -euo pipefail
          echo "Listing terraform-plan artifacts for env: $ENV"
          API_URL="https://api.github.com/repos/$REPO/actions/artifacts?per_page=100"
          echo "Querying GitHub API: $API_URL"
          ARTIFACTS_JSON=$(curl -s -H "Accept: application/vnd.github+json" -H "Authorization: Bearer $GITHUB_TOKEN" "$API_URL")
          echo "$ARTIFACTS_JSON" | jq '.artifacts | length as $n | if $n==0 then [] else . end' >/dev/null || true
          echo "$ARTIFACTS_JSON" | jq -r '.artifacts[] | select(.name | startswith("terraform-plan-'"$ENV"'-")) | {id: .id, name: .name, created_at: .created_at} ' | jq -s '.' > /tmp/filtered_artifacts.json || true
          if [ ! -s /tmp/filtered_artifacts.json ]; then
            echo "No terraform-plan artifacts found for env: $ENV"
            exit 0
          fi
          # Sort by created_at desc and take top 5
          jq -r 'sort_by(.created_at) | reverse | .[0:5][] | "ID:\(.id) NAME:\(.name) CREATED_AT:\(.created_at)"' /tmp/filtered_artifacts.json > /tmp/top_artifacts.txt
          echo "Top artifacts (most recent first):"
          cat /tmp/top_artifacts.txt

          SUGGESTED_SHORT=""
          SUGGESTED_REASON=""
          # For each top artifact, download and inspect metadata if available
          idx=0
          while IFS= read -r line; do
            idx=$((idx+1))
            ID=$(echo "$line" | sed -n 's/.*ID:\([0-9]*\) NAME:\([^ ]*\) CREATED_AT:\(.*\)/\1/p')
            NAME=$(echo "$line" | sed -n 's/.*ID:\([0-9]*\) NAME:\([^ ]*\) CREATED_AT:\(.*\)/\2/p')
            CREATED_AT=$(echo "$line" | sed -n 's/.*ID:\([0-9]*\) NAME:\([^ ]*\) CREATED_AT:\(.*\)/\3/p')
            echo "\nArtifact #$idx -> $NAME (id=$ID) created_at=$CREATED_AT"
            ZIP_URL="https://api.github.com/repos/$REPO/actions/artifacts/$ID/zip"
            TMPZIP="/tmp/artifact_$ID.zip"
            echo "Downloading artifact $NAME..."
            curl -sL -H "Authorization: Bearer $GITHUB_TOKEN" -o "$TMPZIP" "$ZIP_URL"
            TMPDIR="/tmp/artifact_$ID"
            rm -rf "$TMPDIR" && mkdir -p "$TMPDIR"
            unzip -q "$TMPZIP" -d "$TMPDIR" || true
            META="$TMPDIR/tfplan.metadata.json"
            if [ -f "$META" ]; then
              SHORT_SHA=$(jq -r '.short_sha' "$META" || echo "")
              FULL_SHA=$(jq -r '.full_sha' "$META" || echo "")
              BRANCH=$(jq -r '.branch' "$META" || echo "")
              TIMESTAMP=$(jq -r '.timestamp' "$META" || echo "")
              echo "  plan_short_sha: $SHORT_SHA"
              echo "  branch: $BRANCH"
              echo "  commit: $FULL_SHA"
              echo "  timestamp: $TIMESTAMP"
              echo "  artifact_name: $NAME"
              # Suggest if matches current commit
              if [ "$FULL_SHA" = "$GITHUB_SHA" ]; then
                SUGGESTED_SHORT="$SHORT_SHA"
                SUGGESTED_REASON="exact match to current commit"
                break
              fi
              # else if not set suggestion yet, set to first (most recent)
              if [ -z "$SUGGESTED_SHORT" ]; then
                SUGGESTED_SHORT="$SHORT_SHA"
                SUGGESTED_REASON="most recent available"
              fi
            else
              echo "  no tfplan.metadata.json inside artifact"
            fi
          done < /tmp/top_artifacts.txt

          if [ -n "$SUGGESTED_SHORT" ]; then
            echo "\nSuggested plan_short_sha: $SUGGESTED_SHORT ($SUGGESTED_REASON)"
          else
            echo "\nNo suitable plan suggestion found. Provide plan_short_sha manually." 
          fi

      - name: Terraform init
        working-directory: infra/terraform/environments/${{ env.ENV }}
        run: terraform init -input=false

      - name: Download Terraform plan artifact
        uses: actions/download-artifact@v4
        with:
          name: terraform-plan-${{ env.ENV }}-${{ github.event.inputs.plan_short_sha }}
          path: infra/terraform/environments/${{ env.ENV }}

      - name: Validate plan metadata and commit match
        run: |
          METAFILE=infra/terraform/environments/${{ env.ENV }}/tfplan.metadata.json
          PLANFILE=infra/terraform/environments/${{ env.ENV }}/tfplan
          if [ ! -f "$METAFILE" ]; then
            echo "Metadata file not found: $METAFILE"
            ls -la infra/terraform/environments/${{ env.ENV }} || true
            exit 1
          fi
          if [ ! -f "$PLANFILE" ]; then
            echo "Plan file not found: $PLANFILE"
            exit 1
          fi
          FULL_SHA=$(jq -r '.full_sha // empty' "$METAFILE" || true)
          SHORT_SHA=$(jq -r '.short_sha // empty' "$METAFILE" || true)
          echo "Plan metadata short_sha=$SHORT_SHA full_sha=$FULL_SHA"
          if [ "$SHORT_SHA" != "${{ github.event.inputs.plan_short_sha }}" ]; then
            echo "Requested plan short SHA does not match metadata: ${GITHUB_EVENT_NAME}"
            exit 1
          fi
          if [ "$FULL_SHA" != "$GITHUB_SHA" ]; then
            echo "Plan was created for commit $FULL_SHA but this apply run is for commit $GITHUB_SHA. Aborting to prevent drift."
            exit 1
          fi

      - name: Terraform apply saved plan
        working-directory: infra/terraform/environments/${{ env.ENV }}
        run: terraform apply -input=false infra/terraform/environments/${{ env.ENV }}/tfplan
