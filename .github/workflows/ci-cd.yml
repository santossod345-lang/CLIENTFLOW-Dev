name: CI/CD Pipeline
# Architecture: Backend → Railway (auto-deploys on push to main)
#               Frontend → Vercel  (auto-deploys on push to main)
# This workflow handles CI only (lint + test). Deployments are triggered
# automatically by Railway and Vercel via their GitHub integrations.

on:
  push:
    branches: [main, staging]
  pull_request:
    branches: [main, staging]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      - name: Lint (flake8 if available)
        run: |
          if command -v flake8 >/dev/null 2>&1; then flake8 || true; else echo "flake8 not present, skipping"; fi
      - name: Dependency scan (pip-audit if available)
        run: |
          python -m pip install pip-audit || true
          if command -v pip-audit >/dev/null 2>&1; then pip-audit || echo "pip-audit not available"; fi

  test:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      - name: Run tests (pytest)
        run: |
          if [ -f pytest.ini ] || [ -d tests ]; then PYTHONPATH=. pytest -q; else echo "No tests found, skipping"; fi

  check:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
      - name: Verify Railway config
        run: |
          echo "✓ railway.toml present: $(test -f railway.toml && echo yes || echo MISSING)"
          echo "✓ Dockerfile present:   $(test -f Dockerfile && echo yes || echo MISSING)"
          echo "✓ requirements.txt:     $(test -f requirements.txt && echo yes || echo MISSING)"
      - name: Verify Vercel config
        run: |
          echo "✓ vercel.json present:  $(test -f clientflow-frontend/vercel.json && echo yes || echo MISSING)"
          echo "✓ package.json present: $(test -f clientflow-frontend/package.json && echo yes || echo MISSING)"
          echo "✓ vite.config.js:       $(test -f clientflow-frontend/vite.config.js && echo yes || echo MISSING)"
      - name: Summary
        run: |
          echo "Backend (Railway): push to main → Railway auto-deploys via Dockerfile"
          echo "Frontend (Vercel): push to main → Vercel auto-deploys via clientflow-frontend/"
